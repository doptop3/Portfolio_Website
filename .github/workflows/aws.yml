name: Deploy to EC2 Instance

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1

    - name: Start SSH agent and add key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.EC2_RSA_KEY }}

    - name: Log in to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: ~/.buildx-cache
        key: ${{ runner.os }}-docker-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-docker-

    - name: Build and push Docker images
      run: |
        set -e

        mkdir -p $HOME/.buildx-cache
        mkdir -p $HOME/.buildx-cache-new
        
        docker buildx build \
          --cache-from=type=local,src=$HOME/.buildx-cache \
          --cache-to=type=local,dest=$HOME/.buildx-cache-new,mode=max \
          --tag 640168453433.dkr.ecr.ap-southeast-1.amazonaws.com/portfolio-website-frontend:latest \
          --push ./frontend

        docker buildx build \
          --cache-from=type=local,src=$HOME/.buildx-cache \
          --cache-to=type=local,dest=$HOME/.buildx-cache-new,mode=max \
          --tag 640168453433.dkr.ecr.ap-southeast-1.amazonaws.com/portfolio-website-backend:latest \
          --push ./backend

        rm -rf $HOME/.buildx-cache
        mv $HOME/.buildx-cache-new $HOME/.buildx-cache

    - name: Create .env file
      run: |
        cat > .env << EOF
        PGUSER=${{ secrets.PGUSER }}
        PGHOST=${{ secrets.PGHOST }}
        PGDATABASE=${{ secrets.PGDATABASE }}
        PGPASSWORD=${{ secrets.PGPASSWORD }}
        PGPORT=${{ secrets.PGPORT }}
        EOF
        chmod 600 .env

    - name: Ensure rsync is installed on EC2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          if ! command -v rsync >/dev/null 2>&1; then
            echo "Installing rsync on Debian..."
            sudo apt update && sudo apt install -y rsync
          else
            echo "✅ rsync is already installed."
          fi
        EOF

    - name: Sync project files to EC2
      run: |
        rsync -avz --delete \
          -e "ssh -o StrictHostKeyChecking=no" \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='.buildx-cache' \
          --exclude='node_modules' \
          --exclude='*.log' \
          --exclude='.env' \
          ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/Portfolio_Website/

    - name: Transfer .env to EC2
      run: |
        scp -o StrictHostKeyChecking=no .env \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/Portfolio_Website/.env

    - name: SSH into EC2 and deploy
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
        set -euxo pipefail

        echo "Starting deployment..."

        cd ~/Portfolio_Website

        echo "Logging into Amazon ECR..."
        aws ecr get-login-password --region ap-southeast-1 | docker login --username AWS --password-stdin 640168453433.dkr.ecr.ap-southeast-1.amazonaws.com

        echo "Pulling updated Docker images..."
        docker-compose pull # frontend backend

        echo "Restarting containers..."
        docker-compose down
        docker-compose up -d --remove-orphans

        echo "Wait for services..."
        sleep 10

        echo "Docker-container status:"
        docker-compose ps

        echo "Cleaning up unused Docker images..."
        docker image prune -f --filter "dangling=true"

        echo "✅ Deployment complete."
        EOF